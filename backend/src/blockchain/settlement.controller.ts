import {
  Controller,
  Post,
  Param,
  Body,
  ParseUUIDPipe,
  Get,
  Query,
  DefaultValuePipe,
  ParseIntPipe,
} from '@nestjs/common';
import {
  ApiTags,
  ApiOperation,
  ApiBearerAuth,
  ApiParam,
  ApiResponse,
} from '@nestjs/swagger';
import { SettlementService } from './settlement.service';
import { Settlement, SettlementStatus } from './entities/settlement.entity';
import { BackendExecutorAction } from '../auth/decorators/contract-roles.decorator';
import { UserRole } from '../users/entities/user.entity';

class SettleBetDto {
  outcome: string;
  amount: number;
}

@ApiTags('Blockchain Settlement')
@Controller('blockchain/settlement')
export class SettlementController {
  constructor(private readonly settlementService: SettlementService) {}

  /**
   * Settle a bet on the blockchain
   * POST /blockchain/settlement/bets/:betId/settle
   * Requires BACKEND_EXECUTOR or ADMIN role
   */
  @Post('bets/:betId/settle')
  @BackendExecutorAction('settle_bet')
  @ApiParam({ name: 'betId', description: 'Bet ID to settle' })
  @ApiOperation({
    summary: 'Settle a bet on blockchain',
    description: 'Initiate settlement for a bet. Requires BACKEND_EXECUTOR or ADMIN role.',
  })
  @ApiResponse({
    status: 200,
    description: 'Settlement initiated successfully',
  })
  @ApiResponse({
    status: 403,
    description: 'Forbidden - requires BACKEND_EXECUTOR or ADMIN role',
  })
  async settleBet(
    @Param('betId', ParseUUIDPipe) betId: string,
    @Body() dto: SettleBetDto,
  ): Promise<Settlement> {
    return this.settlementService.settleBet(betId, dto.outcome, dto.amount);
  }

  /**
   * Trigger reconciliation of pending settlements
   * POST /blockchain/settlement/reconcile
   * Requires BACKEND_EXECUTOR or ADMIN role
   */
  @Post('reconcile')
  @BackendExecutorAction('reconcile_settlements')
  @ApiOperation({
    summary: 'Reconcile pending settlements',
    description: 'Check and update status of pending blockchain settlements. Requires BACKEND_EXECUTOR or ADMIN role.',
  })
  @ApiResponse({
    status: 200,
    description: 'Reconciliation completed',
  })
  async reconcile(): Promise<{ message: string; processed: number }> {
    await this.settlementService.reconcile();
    return {
      message: 'Reconciliation completed successfully',
      processed: 0, // This would be populated from actual reconciliation results
    };
  }

  /**
   * Get pending settlements
   * GET /blockchain/settlement/pending
   * Requires BACKEND_EXECUTOR or ADMIN role
   */
  @Get('pending')
  @BackendExecutorAction('view_pending_settlements')
  @ApiOperation({
    summary: 'Get pending settlements',
    description: 'List all settlements awaiting blockchain confirmation.',
  })
  async getPendingSettlements(): Promise<Settlement[]> {
    // This would need to be added to the service
    return [];
  }

  /**
   * Get settlement by ID
   * GET /blockchain/settlement/:id
   * Requires BACKEND_EXECUTOR or ADMIN role
   */
  @Get(':id')
  @BackendExecutorAction('view_settlement')
  @ApiParam({ name: 'id', description: 'Settlement ID' })
  @ApiOperation({
    summary: 'Get settlement details',
    description: 'Get details of a specific settlement.',
  })
  async getSettlement(
    @Param('id', ParseUUIDPipe) id: string,
  ): Promise<Settlement | null> {
    // This would need to be added to the service
    return null;
  }
}
